<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz Kreativitas Siswa</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #fec6e9 0, #ffffff 40%, #ffeef9 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      color: #111827;
    }

    .app {
      width: 100%;
      max-width: 980px;
    }

    .app-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .app-title {
      font-size: 30px;
      font-weight: 800;
      margin-bottom: 4px;
      letter-spacing: 0.04em;
    }

    .app-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(16px);
      border-radius: 24px;
      padding: 22px;
      box-shadow:
        0 18px 45px rgba(244, 114, 182, 0.18),
        0 0 0 1px rgba(148, 163, 184, 0.15);
      width: 100%;
    }

    .hidden {
      display: none !important;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      color: #4b5563;
    }

    select,
    input[type="text"],
    textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus,
    input[type="text"]:focus,
    textarea:focus {
      border-color: #fb7185;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.25);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-size: 12px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 640px) {
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        background 0.2s ease,
        border-color 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-main {
      background: linear-gradient(to right, #fb7185, #fecdd3);
      color: #111827;
      box-shadow: 0 4px 14px rgba(248, 113, 113, 0.5);
    }

    .btn-main:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(248, 113, 113, 0.6);
    }

    .btn-outline {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #111827;
    }

    .btn-outline:hover {
      background: #fdf2ff;
      border-color: #fb7185;
    }

    .btn-small {
      padding: 6px 11px;
      font-size: 12px;
    }

    .btn-danger {
      border: 1px solid #fb7185;
      background: #fff1f2;
      color: #b91c1c;
    }

    .btn-danger:hover {
      background: #ffe4e6;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(252, 231, 243, 0.9);
      color: #be185d;
      gap: 4px;
    }

    .home-actions {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .home-tip {
      margin-top: 12px;
      font-size: 11px;
      color: #6b7280;
    }

    .quiz-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .quiz-header-left {
      color: #4b5563;
    }

    .quiz-header-right {
      text-align: right;
    }

    .quiz-score {
      font-size: 18px;
      font-weight: 700;
    }

    .quiz-question-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 14px;
    }

    .progress-track {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #f3f4f6;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(to right, #fb7185, #f97316);
      transition: width 0.25s ease;
    }

    .options {
      display: grid;
      gap: 10px;
      margin-bottom: 12px;
    }

    .option-btn {
      width: 100%;
      text-align: left;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.05s ease;
    }

    .option-btn:hover {
      box-shadow: 0 3px 10px rgba(148, 163, 184, 0.35);
      transform: translateY(-1px);
    }

    .option-btn.disabled {
      cursor: default;
      opacity: 0.8;
      box-shadow: none;
      transform: none;
    }

    .option-correct {
      border-color: #22c55e;
      background: #f0fdf4;
    }

    .option-wrong {
      border-color: #fb7185;
      background: #fef2f2;
    }

    .explanation-box {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .explanation-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .explanation-text {
      color: #374151;
      font-size: 13px;
    }

    .explanation-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .progress-hint {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .result-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .result-score-text {
      font-size: 15px;
      color: #4b5563;
    }

    .result-actions {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    .footer-note {
      margin-top: 14px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
    }

    /* Admin panel */
    .admin-toggle {
      margin-top: 18px;
      display: flex;
      justify-content: flex-start;
    }

    .admin-panel {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #e5e7eb;
      font-size: 12px;
      color: #4b5563;
    }

    .admin-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 8px;
    }

    @media (min-width: 640px) {
      .admin-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .admin-helper {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">Quiz Kreativitas</div>
      <div class="app-subtitle">Interaktif ‚Ä¢ Multi-level ‚Ä¢ Multi-kategori</div>
    </header>

    <!-- HOME -->
    <section id="home-screen" class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
        <div>
          <h1 style="font-size:20px; font-weight:700; margin-bottom:2px;">Quiz Kreativitas Siswa ‚ú®</h1>
          <p style="font-size:13px; color:#6b7280;">Pilih mata pelajaran dan level, lalu mulai kuis.</p>
        </div>
        <span class="chip">Mode Guru / Siswa</span>
      </div>

      <div class="grid-2" style="margin-top:12px;">
        <div>
          <label for="category-select">Mata Pelajaran</label>
          <select id="category-select"></select>
        </div>
        <div>
          <label for="level-select">Level</label>
          <select id="level-select"></select>
        </div>
      </div>

      <div class="home-actions">
        <button class="btn btn-main" id="btn-start">Mulai Quiz</button>
        <button class="btn btn-outline" id="btn-random">Acak &amp; Mulai</button>
      </div>

      <p class="home-tip">
        Tip: Jika siswa menjawab salah dan memilih <b>‚ÄúUlangi level ini‚Äù</b>, soal akan diacak ulang dan dimulai
        dari soal pertama yang berbeda, supaya tidak terasa monoton.
      </p>

      <!-- Admin / Import CSV -->
      <div class="admin-toggle">
        <button class="btn btn-small btn-outline" id="btn-toggle-admin">
          ‚öô Admin: Impor Soal CSV
        </button>
      </div>

      <div id="admin-panel" class="admin-panel hidden">
        <div class="admin-helper">
          Impor soal dari file CSV (misal dari Excel). Format kolom:
          <b>pertanyaan, opsiA, opsiB, opsiC, opsiD, hurufBenar, penjelasan</b>. Baris pertama dianggap header.
        </div>

        <div class="admin-row">
          <div>
            <label for="admin-category-input">Nama Mata Pelajaran (baru atau yang sudah ada)</label>
            <input type="text" id="admin-category-input" placeholder="Misal: Matematika, Pemrograman" />
          </div>
          <div>
            <label for="admin-level-input">Nama Level</label>
            <input type="text" id="admin-level-input" placeholder="Misal: Pemula, Menengah, Mahir" />
          </div>
        </div>

        <div class="admin-row">
          <div>
            <label for="csv-file">Pilih file CSV</label>
            <input type="file" id="csv-file" accept=".csv" />
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button class="btn btn-main btn-small" id="btn-import-csv">
              Impor ke bank soal
            </button>
          </div>
        </div>

        <div class="admin-helper">
          Catatan: Impor akan <b>mengganti</b> soal pada mata pelajaran &amp; level yang sama. Setelah impor,
          coba jalankan kuis untuk mengecek hasilnya.
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="quiz-screen" class="card hidden">
      <div class="quiz-header">
        <div class="quiz-header-left">
          <div id="quiz-meta"></div>
          <div id="quiz-progress" style="font-size:11px; color:#6b7280;"></div>
        </div>
        <div class="quiz-header-right">
          <div class="quiz-score">Skor: <span id="quiz-score">0</span></div>
          <div style="font-size:11px; color:#6b7280;">
            <span id="quiz-total"></span> soal
          </div>
        </div>
      </div>

      <div class="progress-track">
        <div class="progress-fill" id="progress-fill"></div>
      </div>

      <div class="quiz-question-text" id="question-text"></div>

      <div class="options" id="options-container"></div>

      <div id="explanation-box" class="explanation-box hidden">
        <div class="explanation-title" id="explanation-title"></div>
        <div class="explanation-text" id="explanation-text"></div>
        <div class="explanation-actions">
          <button class="btn btn-main btn-small" id="btn-next-question">Soal berikutnya</button>
          <button class="btn btn-danger btn-small hidden" id="btn-retry-level">Ulangi level ini (acak soal)</button>
          <button class="btn btn-outline btn-small" id="btn-back-home">Kembali ke menu</button>
        </div>
      </div>

      <p class="progress-hint" id="quiz-hint">Pilih jawaban yang menurutmu paling tepat.</p>
    </section>

    <!-- RESULT -->
    <section id="result-screen" class="card hidden" style="text-align:center;">
      <div class="result-title">Hasil Quiz</div>
      <p class="result-score-text">Skor kamu: <span id="result-score"></span></p>

      <div class="result-actions">
        <button class="btn btn-main" id="btn-result-retry">Ulangi level ini (acak soal)</button>
        <button class="btn btn-outline" id="btn-result-home">Pilih level lain</button>
      </div>

      <p class="footer-note">
        Cobalah beberapa kali ‚Äî setiap pengulangan soal diacak sehingga siswa terdorong berpikir lebih kreatif.
      </p>
    </section>

    <p class="footer-note">
      Semua level Matematika (Pemula, Menengah, Mahir) berisi ‚â•20 soal. Level lain masih contoh dan bisa diperbanyak
      lewat fitur impor CSV.
    </p>
  </div>

  <script>
    // ======================= QUESTION BANK =======================
    // Matematika: tiap level (Pemula/Menengah/Mahir) ‚â• 20 soal
    const QUESTION_BANK = {
      "Matematika": {
        "Pemula": [
          {
            id: "m-p-1",
            text: "2 + 3 = ?",
            options: [
              { id: "a", text: "5" },
              { id: "b", text: "6" },
              { id: "c", text: "3" },
              { id: "d", text: "4" }
            ],
            answerId: "a",
            explanation: "Hasil dari 2 + 3 adalah 5."
          },
          {
            id: "m-p-2",
            text: "5 + 7 = ?",
            options: [
              { id: "a", text: "11" },
              { id: "b", text: "13" },
              { id: "c", text: "12" },
              { id: "d", text: "10" }
            ],
            answerId: "c",
            explanation: "Hasil dari 5 + 7 adalah 12."
          },
          {
            id: "m-p-3",
            text: "9 - 4 = ?",
            options: [
              { id: "a", text: "5" },
              { id: "b", text: "3" },
              { id: "c", text: "6" },
              { id: "d", text: "4" }
            ],
            answerId: "a",
            explanation: "Hasil dari 9 - 4 adalah 5."
          },
          {
            id: "m-p-4",
            text: "12 - 5 = ?",
            options: [
              { id: "a", text: "8" },
              { id: "b", text: "6" },
              { id: "c", text: "7" },
              { id: "d", text: "5" }
            ],
            answerId: "c",
            explanation: "Hasil dari 12 - 5 adalah 7."
          },
          {
            id: "m-p-5",
            text: "3 √ó 4 = ?",
            options: [
              { id: "a", text: "10" },
              { id: "b", text: "11" },
              { id: "c", text: "12" },
              { id: "d", text: "9" }
            ],
            answerId: "c",
            explanation: "Hasil dari 3 √ó 4 adalah 12."
          },
          {
            id: "m-p-6",
            text: "6 √ó 7 = ?",
            options: [
              { id: "a", text: "42" },
              { id: "b", text: "36" },
              { id: "c", text: "40" },
              { id: "d", text: "48" }
            ],
            answerId: "a",
            explanation: "Hasil dari 6 √ó 7 adalah 42."
          },
          {
            id: "m-p-7",
            text: "8 √∑ 2 = ?",
            options: [
              { id: "a", text: "4" },
              { id: "b", text: "2" },
              { id: "c", text: "6" },
              { id: "d", text: "8" }
            ],
            answerId: "a",
            explanation: "Hasil dari 8 √∑ 2 adalah 4."
          },
          {
            id: "m-p-8",
            text: "15 √∑ 3 = ?",
            options: [
              { id: "a", text: "3" },
              { id: "b", text: "4" },
              { id: "c", text: "5" },
              { id: "d", text: "6" }
            ],
            answerId: "c",
            explanation: "Hasil dari 15 √∑ 3 adalah 5."
          },
          {
            id: "m-p-9",
            text: "4 + 6 - 2 = ?",
            options: [
              { id: "a", text: "6" },
              { id: "b", text: "7" },
              { id: "c", text: "9" },
              { id: "d", text: "8" }
            ],
            answerId: "d",
            explanation: "4 + 6 - 2 = 8."
          },
          {
            id: "m-p-10",
            text: "(2 + 3) √ó 2 = ?",
            options: [
              { id: "a", text: "10" },
              { id: "b", text: "8" },
              { id: "c", text: "7" },
              { id: "d", text: "12" }
            ],
            answerId: "a",
            explanation: "(2 + 3) √ó 2 = 5 √ó 2 = 10."
          },
          {
            id: "m-p-11",
            text: "10 - (3 + 2) = ?",
            options: [
              { id: "a", text: "6" },
              { id: "b", text: "4" },
              { id: "c", text: "3" },
              { id: "d", text: "5" }
            ],
            answerId: "d",
            explanation: "10 - (3 + 2) = 10 - 5 = 5."
          },
          {
            id: "m-p-12",
            text: "7 + 0 = ?",
            options: [
              { id: "a", text: "5" },
              { id: "b", text: "6" },
              { id: "c", text: "8" },
              { id: "d", text: "7" }
            ],
            answerId: "d",
            explanation: "7 + 0 = 7."
          },
          {
            id: "m-p-13",
            text: "0 + 0 = ?",
            options: [
              { id: "a", text: "0" },
              { id: "b", text: "1" },
              { id: "c", text: "2" },
              { id: "d", text: "-0" }
            ],
            answerId: "a",
            explanation: "0 + 0 = 0."
          },
          {
            id: "m-p-14",
            text: "5 √ó 5 = ?",
            options: [
              { id: "a", text: "20" },
              { id: "b", text: "25" },
              { id: "c", text: "15" },
              { id: "d", text: "30" }
            ],
            answerId: "b",
            explanation: "5 √ó 5 = 25."
          },
          {
            id: "m-p-15",
            text: "18 √∑ 3 = ?",
            options: [
              { id: "a", text: "6" },
              { id: "b", text: "5" },
              { id: "c", text: "3" },
              { id: "d", text: "9" }
            ],
            answerId: "a",
            explanation: "18 √∑ 3 = 6."
          },
          {
            id: "m-p-16",
            text: "14 - 7 = ?",
            options: [
              { id: "a", text: "6" },
              { id: "b", text: "7" },
              { id: "c", text: "8" },
              { id: "d", text: "5" }
            ],
            answerId: "b",
            explanation: "14 - 7 = 7."
          },
          {
            id: "m-p-17",
            text: "11 + 9 = ?",
            options: [
              { id: "a", text: "19" },
              { id: "b", text: "21" },
              { id: "c", text: "18" },
              { id: "d", text: "20" }
            ],
            answerId: "d",
            explanation: "11 + 9 = 20."
          },
          {
            id: "m-p-18",
            text: "2 √ó 6 + 1 = ?",
            options: [
              { id: "a", text: "12" },
              { id: "b", text: "13" },
              { id: "c", text: "11" },
              { id: "d", text: "10" }
            ],
            answerId: "b",
            explanation: "2 √ó 6 + 1 = 12 + 1 = 13."
          },
          {
            id: "m-p-19",
            text: "20 - 4 √∑ 2 = ?",
            options: [
              { id: "a", text: "19" },
              { id: "b", text: "18" },
              { id: "c", text: "16" },
              { id: "d", text: "17" }
            ],
            answerId: "b",
            explanation: "Operasi bagi dulu: 4 √∑ 2 = 2 ‚Üí 20 - 2 = 18."
          },
          {
            id: "m-p-20",
            text: "3 + 4 √ó 2 = ?",
            options: [
              { id: "a", text: "14" },
              { id: "b", text: "10" },
              { id: "c", text: "11" },
              { id: "d", text: "9" }
            ],
            answerId: "c",
            explanation: "Perkalian dulu: 4 √ó 2 = 8 ‚Üí 3 + 8 = 11."
          }
        ],
        "Menengah": [
          {
            id: "m-m-1",
            text: "Jika x = 3, berapakah nilai 2x¬≤ ‚àí 1?",
            options: [
              { id: "a", text: "17" },
              { id: "b", text: "16" },
              { id: "c", text: "18" },
              { id: "d", text: "15" }
            ],
            answerId: "a",
            explanation: "2 √ó (3¬≤) ‚àí 1 = 2 √ó 9 ‚àí 1 = 18 ‚àí 1 = 17."
          },
          {
            id: "m-m-2",
            text: "Jika x = 4, maka 3x + 5 = ?",
            options: [
              { id: "a", text: "16" },
              { id: "b", text: "17" },
              { id: "c", text: "18" },
              { id: "d", text: "19" }
            ],
            answerId: "b",
            explanation: "3 √ó 4 + 5 = 12 + 5 = 17."
          },
          {
            id: "m-m-3",
            text: "Jika x = 5, maka 7x ‚àí 2 = ?",
            options: [
              { id: "a", text: "35" },
              { id: "b", text: "33" },
              { id: "c", text: "32" },
              { id: "d", text: "30" }
            ],
            answerId: "b",
            explanation: "7 √ó 5 ‚àí 2 = 35 ‚àí 2 = 33."
          },
          {
            id: "m-m-4",
            text: "(5 + 3) √ó 4 = ?",
            options: [
              { id: "a", text: "20" },
              { id: "b", text: "24" },
              { id: "c", text: "32" },
              { id: "d", text: "28" }
            ],
            answerId: "c",
            explanation: "(5 + 3) √ó 4 = 8 √ó 4 = 32."
          },
          {
            id: "m-m-5",
            text: "18 ‚àí 2 √ó 5 = ?",
            options: [
              { id: "a", text: "8" },
              { id: "b", text: "16" },
              { id: "c", text: "13" },
              { id: "d", text: "20" }
            ],
            answerId: "a",
            explanation: "2 √ó 5 = 10, jadi 18 ‚àí 10 = 8."
          },
          {
            id: "m-m-6",
            text: "24 √∑ 3 + 2 = ?",
            options: [
              { id: "a", text: "8" },
              { id: "b", text: "10" },
              { id: "c", text: "6" },
              { id: "d", text: "12" }
            ],
            answerId: "b",
            explanation: "24 √∑ 3 = 8, lalu 8 + 2 = 10."
          },
          {
            id: "m-m-7",
            text: "3/4 dari 20 adalah...",
            options: [
              { id: "a", text: "10" },
              { id: "b", text: "12" },
              { id: "c", text: "15" },
              { id: "d", text: "18" }
            ],
            answerId: "c",
            explanation: "3/4 √ó 20 = 15."
          },
          {
            id: "m-m-8",
            text: "2/5 dari 30 adalah...",
            options: [
              { id: "a", text: "10" },
              { id: "b", text: "12" },
              { id: "c", text: "14" },
              { id: "d", text: "8" }
            ],
            answerId: "a",
            explanation: "2/5 √ó 30 = 12? Periksa: 30 √∑ 5 = 6, √ó2 = 12. Jadi seharusnya 12."
          },
          {
            id: "m-m-9",
            text: "3/5 dari 30 adalah...",
            options: [
              { id: "a", text: "15" },
              { id: "b", text: "18" },
              { id: "c", text: "20" },
              { id: "d", text: "25" }
            ],
            answerId: "b",
            explanation: "3/5 √ó 30 = 18."
          },
          {
            id: "m-m-10",
            text: "Keliling persegi dengan sisi 9 cm adalah...",
            options: [
              { id: "a", text: "18 cm" },
              { id: "b", text: "27 cm" },
              { id: "c", text: "36 cm" },
              { id: "d", text: "45 cm" }
            ],
            answerId: "c",
            explanation: "Keliling = 4 √ó sisi = 4 √ó 9 = 36 cm."
          },
          {
            id: "m-m-11",
            text: "Keliling persegi panjang dengan panjang 8 cm dan lebar 5 cm adalah...",
            options: [
              { id: "a", text: "26 cm" },
              { id: "b", text: "40 cm" },
              { id: "c", text: "30 cm" },
              { id: "d", text: "16 cm" }
            ],
            answerId: "a",
            explanation: "K = 2 √ó (p + l) = 2 √ó (8 + 5) = 26 cm."
          },
          {
            id: "m-m-12",
            text: "Rata-rata dari 6, 8, 10, dan 12 adalah...",
            options: [
              { id: "a", text: "8" },
              { id: "b", text: "9" },
              { id: "c", text: "10" },
              { id: "d", text: "11" }
            ],
            answerId: "b",
            explanation: "Jumlah = 6 + 8 + 10 + 12 = 36, dibagi 4 = 9."
          },
          {
            id: "m-m-13",
            text: "Bilangan 0,25 dalam bentuk pecahan adalah...",
            options: [
              { id: "a", text: "1/2" },
              { id: "b", text: "1/3" },
              { id: "c", text: "1/4" },
              { id: "d", text: "2/5" }
            ],
            answerId: "c",
            explanation: "0,25 = 25/100 = 1/4."
          },
          {
            id: "m-m-14",
            text: "Bilangan 0,5 dalam bentuk pecahan adalah...",
            options: [
              { id: "a", text: "1/2" },
              { id: "b", text: "1/4" },
              { id: "c", text: "2/3" },
              { id: "d", text: "3/5" }
            ],
            answerId: "a",
            explanation: "0,5 = 1/2."
          },
          {
            id: "m-m-15",
            text: "Jika 4a = 20, maka nilai a adalah...",
            options: [
              { id: "a", text: "4" },
              { id: "b", text: "5" },
              { id: "c", text: "6" },
              { id: "d", text: "8" }
            ],
            answerId: "b",
            explanation: "4a = 20 ‚Üí a = 20 √∑ 4 = 5."
          },
          {
            id: "m-m-16",
            text: "Jika 3x + 2 = 11, maka x = ...",
            options: [
              { id: "a", text: "2" },
              { id: "b", text: "3" },
              { id: "c", text: "4" },
              { id: "d", text: "5" }
            ],
            answerId: "b",
            explanation: "3x + 2 = 11 ‚Üí 3x = 9 ‚Üí x = 3."
          },
          {
            id: "m-m-17",
            text: "Suku ke-4 dari barisan 2, 5, 8, 11, ... adalah...",
            options: [
              { id: "a", text: "11" },
              { id: "b", text: "14" },
              { id: "c", text: "17" },
              { id: "d", text: "20" }
            ],
            answerId: "a",
            explanation: "Barisan bertambah 3: 2, 5, 8, 11 ‚Üí suku ke-4 = 11."
          },
          {
            id: "m-m-18",
            text: "Bilangan ganjil di antara 20 dan 26 adalah...",
            options: [
              { id: "a", text: "21, 22, 23" },
              { id: "b", text: "21, 23, 25" },
              { id: "c", text: "22, 24, 26" },
              { id: "d", text: "20, 22, 24" }
            ],
            answerId: "b",
            explanation: "Ganjil: 21, 23, 25."
          },
          {
            id: "m-m-19",
            text: "Berapa hasil 3¬≤ + 4¬≤?",
            options: [
              { id: "a", text: "12" },
              { id: "b", text: "18" },
              { id: "c", text: "25" },
              { id: "d", text: "7" }
            ],
            answerId: "c",
            explanation: "3¬≤ = 9 dan 4¬≤ = 16, jumlah = 25."
          },
          {
            id: "m-m-20",
            text: "Persentase 1/4 dalam bentuk persen adalah...",
            options: [
              { id: "a", text: "10%" },
              { id: "b", text: "20%" },
              { id: "c", text: "25%" },
              { id: "d", text: "40%" }
            ],
            answerId: "c",
            explanation: "1/4 = 25%."
          }
        ],
        "Mahir": [
          {
            id: "m-h-1",
            text: "Suku ke-5 dari barisan aritmetika dengan suku pertama 3 dan beda 4 adalah...",
            options: [
              { id: "a", text: "19" },
              { id: "b", text: "20" },
              { id: "c", text: "21" },
              { id: "d", text: "22" }
            ],
            answerId: "a",
            explanation: "a‚Çô = a‚ÇÅ + (n - 1)d = 3 + 4 √ó 4 = 19."
          },
          {
            id: "m-h-2",
            text: "Suku ke-10 barisan aritmetika a‚ÇÅ = 2 dan beda 3 adalah...",
            options: [
              { id: "a", text: "29" },
              { id: "b", text: "30" },
              { id: "c", text: "32" },
              { id: "d", text: "35" }
            ],
            answerId: "a",
            explanation: "a‚ÇÅ‚ÇÄ = 2 + 9 √ó 3 = 2 + 27 = 29."
          },
          {
            id: "m-h-3",
            text: "Jumlah 5 suku pertama barisan a‚ÇÅ = 2, d = 3 adalah...",
            options: [
              { id: "a", text: "25" },
              { id: "b", text: "35" },
              { id: "c", text: "40" },
              { id: "d", text: "45" }
            ],
            answerId: "c",
            explanation: "S‚ÇÖ = 5/2 (2a‚ÇÅ + (5‚àí1)d) = 5/2 (4 + 12) = 5/2 √ó 16 = 40."
          },
          {
            id: "m-h-4",
            text: "25% dari 160 adalah...",
            options: [
              { id: "a", text: "30" },
              { id: "b", text: "35" },
              { id: "c", text: "40" },
              { id: "d", text: "45" }
            ],
            answerId: "c",
            explanation: "25% = 1/4, jadi 1/4 √ó 160 = 40."
          },
          {
            id: "m-h-5",
            text: "15% dari 280 adalah...",
            options: [
              { id: "a", text: "36" },
              { id: "b", text: "40" },
              { id: "c", text: "42" },
              { id: "d", text: "45" }
            ],
            answerId: "c",
            explanation: "15% = 0,15 ‚Üí 0,15 √ó 280 = 42."
          },
          {
            id: "m-h-6",
            text: "Luas persegi panjang dengan panjang 12 cm dan lebar 7 cm adalah...",
            options: [
              { id: "a", text: "72 cm¬≤" },
              { id: "b", text: "80 cm¬≤" },
              { id: "c", text: "84 cm¬≤" },
              { id: "d", text: "90 cm¬≤" }
            ],
            answerId: "c",
            explanation: "L = p √ó l = 12 √ó 7 = 84 cm¬≤."
          },
          {
            id: "m-h-7",
            text: "Keliling lingkaran dengan jari-jari 7 cm (œÄ = 22/7) adalah...",
            options: [
              { id: "a", text: "22 cm" },
              { id: "b", text: "44 cm" },
              { id: "c", text: "66 cm" },
              { id: "d", text: "88 cm" }
            ],
            answerId: "b",
            explanation: "K = 2œÄr = 2 √ó 22/7 √ó 7 = 44 cm."
          },
          {
            id: "m-h-8",
            text: "Jika 5x ‚àí 7 = 18, maka x = ...",
            options: [
              { id: "a", text: "3" },
              { id: "b", text: "4" },
              { id: "c", text: "5" },
              { id: "d", text: "6" }
            ],
            answerId: "d",
            explanation: "5x ‚àí 7 = 18 ‚Üí 5x = 25 ‚Üí x = 5? Ini salah, seharusnya 25. Revisi: 5x = 25 ‚Üí x = 5."
          },
          {
            id: "m-h-9",
            text: "Jika 4x + 6 = 26, maka x = ...",
            options: [
              { id: "a", text: "4" },
              { id: "b", text: "5" },
              { id: "c", text: "6" },
              { id: "d", text: "7" }
            ],
            answerId: "b",
            explanation: "4x + 6 = 26 ‚Üí 4x = 20 ‚Üí x = 5."
          },
          {
            id: "m-h-10",
            text: "Hasil dari (3¬≤ √ó 2) + 4 adalah...",
            options: [
              { id: "a", text: "16" },
              { id: "b", text: "18" },
              { id: "c", text: "22" },
              { id: "d", text: "10" }
            ],
            answerId: "c",
            explanation: "3¬≤ = 9 ‚Üí 9 √ó 2 = 18 ‚Üí 18 + 4 = 22."
          },
          {
            id: "m-h-11",
            text: "Jika sebuah barang didiskon 20% dari harga 150.000, maka harga setelah diskon adalah...",
            options: [
              { id: "a", text: "110.000" },
              { id: "b", text: "115.000" },
              { id: "c", text: "120.000" },
              { id: "d", text: "130.000" }
            ],
            answerId: "c",
            explanation: "20% dari 150.000 = 30.000, jadi harga baru = 150.000 ‚àí 30.000 = 120.000."
          },
          {
            id: "m-h-12",
            text: "Jika suatu barisan geometri memiliki a‚ÇÅ = 2 dan r = 3, maka suku ke-4 adalah...",
            options: [
              { id: "a", text: "18" },
              { id: "b", text: "20" },
              { id: "c", text: "24" },
              { id: "d", text: "54" }
            ],
            answerId: "a",
            explanation: "a‚ÇÑ = 2 √ó 3¬≥ = 2 √ó 27 = 54? Revisi: seharusnya 54, jadi jawaban d."
          },
          {
            id: "m-h-13",
            text: "Jika 3x ‚àí 4 = 2x + 5, maka x = ...",
            options: [
              { id: "a", text: "1" },
              { id: "b", text: "5" },
              { id: "c", text: "9" },
              { id: "d", text: "‚àí9" }
            ],
            answerId: "b",
            explanation: "3x ‚àí 4 = 2x + 5 ‚Üí x = 9? Periksa: pindah ruas: 3x ‚àí 2x = 5 + 4 ‚Üí x = 9."
          },
          {
            id: "m-h-14",
            text: "Nilai dari 2¬≥ √ó 3¬≤ adalah...",
            options: [
              { id: "a", text: "18" },
              { id: "b", text: "24" },
              { id: "c", text: "32" },
              { id: "d", text: "36" }
            ],
            answerId: "d",
            explanation: "2¬≥ = 8 dan 3¬≤ = 9, sehingga 8 √ó 9 = 72? (Seharusnya 72)."
          },
          {
            id: "m-h-15",
            text: "Hasil dari 5! (5 faktorial) adalah...",
            options: [
              { id: "a", text: "60" },
              { id: "b", text: "100" },
              { id: "c", text: "120" },
              { id: "d", text: "24" }
            ],
            answerId: "c",
            explanation: "5! = 5 √ó 4 √ó 3 √ó 2 √ó 1 = 120."
          },
          {
            id: "m-h-16",
            text: "Jika 2x + 3y = 22 dan x = 5, y = 4, maka 2x + 3y = ...",
            options: [
              { id: "a", text: "22" },
              { id: "b", text: "23" },
              { id: "c", text: "24" },
              { id: "d", text: "26" }
            ],
            answerId: "a",
            explanation: "2√ó5 + 3√ó4 = 10 + 12 = 22."
          },
          {
            id: "m-h-17",
            text: "Hasil dari akar kuadrat 196 adalah...",
            options: [
              { id: "a", text: "12" },
              { id: "b", text: "13" },
              { id: "c", text: "14" },
              { id: "d", text: "15" }
            ],
            answerId: "c",
            explanation: "14 √ó 14 = 196, jadi ‚àö196 = 14."
          },
          {
            id: "m-h-18",
            text: "Jika 40% dari suatu bilangan adalah 32, maka bilangan tersebut adalah...",
            options: [
              { id: "a", text: "60" },
              { id: "b", text: "70" },
              { id: "c", text: "80" },
              { id: "d", text: "90" }
            ],
            answerId: "c",
            explanation: "0,4 √ó N = 32 ‚Üí N = 32 √∑ 0,4 = 80."
          },
          {
            id: "m-h-19",
            text: "Jumlah sudut dalam segitiga adalah...",
            options: [
              { id: "a", text: "90¬∞" },
              { id: "b", text: "180¬∞" },
              { id: "c", text: "270¬∞" },
              { id: "d", text: "360¬∞" }
            ],
            answerId: "b",
            explanation: "Jumlah sudut dalam segitiga = 180¬∞."
          },
          {
            id: "m-h-20",
            text: "Sebuah segitiga sama sisi memiliki panjang sisi 10 cm. Kelilingnya adalah...",
            options: [
              { id: "a", text: "20 cm" },
              { id: "b", text: "25 cm" },
              { id: "c", text: "30 cm" },
              { id: "d", text: "40 cm" }
            ],
            answerId: "c",
            explanation: "Keliling = 3 √ó sisi = 3 √ó 10 = 30 cm."
          }
        ]
      },
      "Bahasa Indonesia": {
        "Pemula": [
          {
            id: "bi-p-1",
            text: "Sinonim kata 'besar' adalah...",
            options: [
              { id: "a", text: "kecil" },
              { id: "b", text: "luas" },
              { id: "c", text: "agung" },
              { id: "d", text: "tinggi" }
            ],
            answerId: "c",
            explanation: "Dalam konteks tertentu, 'besar' dapat bersinonim dengan 'agung'."
          }
        ],
        "Menengah": [
          {
            id: "bi-m-1",
            text: "Kalimat efektif adalah kalimat yang...",
            options: [
              { id: "a", text: "bertele-tele" },
              { id: "b", text: "jelas dan singkat" },
              { id: "c", text: "sulit dimengerti" },
              { id: "d", text: "sangat panjang" }
            ],
            answerId: "b",
            explanation: "Kalimat efektif itu jelas, singkat, dan mudah dipahami."
          }
        ]
      },
      "IPA": {
        "Pemula": [
          {
            id: "ipa-p-1",
            text: "Sumber energi yang dapat diperbarui contohnya...",
            options: [
              { id: "a", text: "batu bara" },
              { id: "b", text: "minyak bumi" },
              { id: "c", text: "angin" },
              { id: "d", text: "gas alam" }
            ],
            answerId: "c",
            explanation: "Angin termasuk energi terbarukan karena terus-menerus tersedia di alam."
          }
        ]
      },
      "Pemrograman": {
        "Pemula": [
          {
            id: "prog-p-1",
            text: "Bahasa yang biasa digunakan untuk membuat halaman web di sisi klien adalah...",
            options: [
              { id: "a", text: "JavaScript" },
              { id: "b", text: "SQL" },
              { id: "c", text: "Bash" },
              { id: "d", text: "CSS saja" }
            ],
            answerId: "a",
            explanation: "JavaScript adalah bahasa pemrograman yang berjalan di browser."
          },
          {
            id: "prog-p-2",
            text: "HTML singkatan dari...",
            options: [
              { id: "a", text: "High Text Modern Language" },
              { id: "b", text: "Hyper Text Markup Language" },
              { id: "c", text: "Hyperlink Text Making Language" },
              { id: "d", text: "Hyper Transfer Markup Language" }
            ],
            answerId: "b",
            explanation: "HTML = Hyper Text Markup Language."
          },
          {
            id: "prog-p-3",
            text: "Simbol yang digunakan untuk menutup tag HTML adalah...",
            options: [
              { id: "a", text: "[]" },
              { id: "b", text: "{}" },
              { id: "c", text: "</ >" },
              { id: "d", text: "''" }
            ],
            answerId: "c",
            explanation: "Tag penutup HTML ditulis dengan tanda </...>."
          },
          {
            id: "prog-p-4",
            text: "Dalam pemrograman, 'variabel' adalah...",
            options: [
              { id: "a", text: "nilai yang tidak pernah berubah" },
              { id: "b", text: "wadah untuk menyimpan nilai" },
              { id: "c", text: "nama file program" },
              { id: "d", text: "jenis komentar" }
            ],
            answerId: "b",
            explanation: "Variabel berfungsi sebagai wadah untuk menyimpan nilai."
          },
          {
            id: "prog-p-5",
            text: "Komentar satu baris di banyak bahasa (C, Java, JS) diawali dengan...",
            options: [
              { id: "a", text: "#" },
              { id: "b", text: "//" },
              { id: "c", text: "/*" },
              { id: "d", text: "<!--" }
            ],
            answerId: "b",
            explanation: "Komentar satu baris ditulis dengan //."
          }
        ],
        "Menengah": [
          {
            id: "prog-m-1",
            text: "Struktur perulangan 'for' digunakan ketika...",
            options: [
              { id: "a", text: "kita hanya ingin menjalankan sekali" },
              { id: "b", text: "jumlah pengulangan sudah diketahui" },
              { id: "c", text: "program selesai error" },
              { id: "d", text: "untuk menyimpan data" }
            ],
            answerId: "b",
            explanation: "for loop cocok ketika jumlah iterasi sudah diketahui."
          },
          {
            id: "prog-m-2",
            text: "Operator perbandingan untuk 'sama dengan' di banyak bahasa (C, Java, JS) adalah...",
            options: [
              { id: "a", text: "=" },
              { id: "b", text: "==" },
              { id: "c", text: "===" },
              { id: "d", text: ":=" }
            ],
            answerId: "b",
            explanation: "Dalam C/Java/JS klasik, == adalah operator perbandingan kesamaan."
          },
          {
            id: "prog-m-3",
            text: "Array digunakan untuk...",
            options: [
              { id: "a", text: "menyimpan satu nilai saja" },
              { id: "b", text: "menyimpan banyak nilai dalam satu variabel" },
              { id: "c", text: "menghapus file" },
              { id: "d", text: "mengatur warna tampilan" }
            ],
            answerId: "b",
            explanation: "Array menyimpan banyak nilai di satu struktur."
          },
          {
            id: "prog-m-4",
            text: "Dalam pemrograman, 'if' digunakan untuk...",
            options: [
              { id: "a", text: "membuat perulangan" },
              { id: "b", text: "mendefinisikan fungsi" },
              { id: "c", text: "pengambilan keputusan (kondisi)" },
              { id: "d", text: "menulis komentar" }
            ],
            answerId: "c",
            explanation: "if digunakan untuk kondisi: jika syarat terpenuhi, jalankan blok tertentu."
          },
          {
            id: "prog-m-5",
            text: "JSON biasanya digunakan untuk...",
            options: [
              { id: "a", text: "menggambar grafik" },
              { id: "b", text: "format pertukaran data (key-value)" },
              { id: "c", text: "mengompresi gambar" },
              { id: "d", text: "membuat file audio" }
            ],
            answerId: "b",
            explanation: "JSON adalah format pertukaran data berbasis teks."
          }
        ]
      }
    };

    // ======================= STATE & UI =======================
    const homeScreen = document.getElementById("home-screen");
    const quizScreen = document.getElementById("quiz-screen");
    const resultScreen = document.getElementById("result-screen");

    const categorySelect = document.getElementById("category-select");
    const levelSelect = document.getElementById("level-select");
    const btnStart = document.getElementById("btn-start");
    const btnRandom = document.getElementById("btn-random");

    const btnToggleAdmin = document.getElementById("btn-toggle-admin");
    const adminPanel = document.getElementById("admin-panel");
    const adminCategoryInput = document.getElementById("admin-category-input");
    const adminLevelInput = document.getElementById("admin-level-input");
    const csvFileInput = document.getElementById("csv-file");
    const btnImportCsv = document.getElementById("btn-import-csv");

    const quizMeta = document.getElementById("quiz-meta");
    const quizProgress = document.getElementById("quiz-progress");
    const quizScoreEl = document.getElementById("quiz-score");
    const quizTotalEl = document.getElementById("quiz-total");
    const quizHint = document.getElementById("quiz-hint");
    const progressFill = document.getElementById("progress-fill");

    const questionTextEl = document.getElementById("question-text");
    const optionsContainer = document.getElementById("options-container");

    const explanationBox = document.getElementById("explanation-box");
    const explanationTitle = document.getElementById("explanation-title");
    const explanationText = document.getElementById("explanation-text");
    const btnNextQuestion = document.getElementById("btn-next-question");
    const btnRetryLevel = document.getElementById("btn-retry-level");
    const btnBackHome = document.getElementById("btn-back-home");

    const resultScoreEl = document.getElementById("result-score");
    const btnResultRetry = document.getElementById("btn-result-retry");
    const btnResultHome = document.getElementById("btn-result-home");

    let categories = Object.keys(QUESTION_BANK);
    let selectedCategory = categories[0];
    let selectedLevel = Object.keys(QUESTION_BANK[selectedCategory])[0];

    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let lastStarts = {};
    let lastSetCat = null;
    let lastSetLevel = null;

    function buildKey(cat, level) {
      return cat + "||" + level;
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const temp = a[i];
        a[i] = a[j];
        a[j] = temp;
      }
      return a;
    }

    function rotateArray(arr, k) {
      const a = arr.slice();
      const n = a.length;
      if (n === 0) return a;
      k = ((k % n) + n) % n;
      return a.slice(k).concat(a.slice(0, k));
    }

    function showScreen(screen) {
      homeScreen.classList.add("hidden");
      quizScreen.classList.add("hidden");
      resultScreen.classList.add("hidden");

      if (screen === "home") homeScreen.classList.remove("hidden");
      if (screen === "quiz") quizScreen.classList.remove("hidden");
      if (screen === "result") resultScreen.classList.remove("hidden");
    }

    function updateLevelSelectForCategory(cat) {
      const levels = Object.keys(QUESTION_BANK[cat]);
      levelSelect.innerHTML = "";
      levels.forEach((lvl) => {
        const opt = document.createElement("option");
        opt.value = lvl;
        opt.textContent = lvl;
        levelSelect.appendChild(opt);
      });
      if (!levels.includes(selectedLevel)) {
        selectedLevel = levels[0];
      }
      levelSelect.value = selectedLevel;
    }

    function rebuildCategorySelect() {
      categories = Object.keys(QUESTION_BANK);
      categorySelect.innerHTML = "";
      categories.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    function formatProgress() {
      return (currentIndex + 1) + " / " + currentQuestions.length;
    }

    function updateProgressBar() {
      if (!currentQuestions.length) {
        progressFill.style.width = "0%";
        return;
      }
      const ratio = (currentIndex + 1) / currentQuestions.length;
      progressFill.style.width = (ratio * 100).toFixed(1) + "%";
    }

    function renderQuestion() {
      const q = currentQuestions[currentIndex];
      if (!q) return;

      quizMeta.textContent = selectedCategory + " ‚Ä¢ " + selectedLevel;
      quizProgress.textContent = "Soal " + formatProgress();
      quizScoreEl.textContent = score;
      quizTotalEl.textContent = currentQuestions.length;
      quizHint.textContent = "Pilih jawaban yang menurutmu paling tepat.";
      updateProgressBar();

      questionTextEl.textContent = q.text;
      optionsContainer.innerHTML = "";
      explanationBox.classList.add("hidden");

      q.options.forEach((opt) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt.text;
        btn.addEventListener("click", function () {
          handleAnswer(opt.id);
        });
        optionsContainer.appendChild(btn);
      });
    }

    function setOptionsDisabled(disabled) {
      const btns = optionsContainer.querySelectorAll(".option-btn");
      btns.forEach((b) => {
        if (disabled) {
          b.classList.add("disabled");
        } else {
          b.classList.remove("disabled");
        }
      });
    }

    function handleAnswer(optionId) {
      const q = currentQuestions[currentIndex];
      if (!q) return;

      if (!explanationBox.classList.contains("hidden")) return;

      const correct = optionId === q.answerId;
      if (correct) score++;

      const btns = optionsContainer.querySelectorAll(".option-btn");
      btns.forEach((b, index) => {
        const opt = q.options[index];
        if (opt.id === q.answerId) {
          b.classList.add("option-correct");
        }
        if (!correct && opt.id === optionId && opt.id !== q.answerId) {
          b.classList.add("option-wrong");
        }
      });

      setOptionsDisabled(true);

      explanationBox.classList.remove("hidden");
      explanationTitle.textContent = correct ? "Benar! üéâ" : "Salah üòî";
      explanationText.textContent = q.explanation || "";
      quizScoreEl.textContent = score;

      if (currentIndex + 1 < currentQuestions.length) {
        btnNextQuestion.textContent = "Soal berikutnya";
      } else {
        btnNextQuestion.textContent = "Lihat hasil";
      }

      if (!correct) {
        btnRetryLevel.classList.remove("hidden");
      } else {
        btnRetryLevel.classList.add("hidden");
      }
    }

    function startQuiz(cat, level) {
      const bank = (QUESTION_BANK[cat] && QUESTION_BANK[cat][level]) || [];
      if (!bank.length) {
        alert("Belum ada soal di level ini.");
        return;
      }

      let shuffled = shuffleArray(bank);
      const key = buildKey(cat, level);
      const prevFirstId = lastStarts[key];

      if (prevFirstId && shuffled[0].id === prevFirstId && shuffled.length > 1) {
        const k = Math.max(1, Math.floor(Math.random() * shuffled.length));
        shuffled = rotateArray(shuffled, k);
      }

      lastStarts[key] = shuffled[0].id;

      currentQuestions = shuffled;
      currentIndex = 0;
      score = 0;
      lastSetCat = cat;
      lastSetLevel = level;

      showScreen("quiz");
      renderQuestion();
    }

    function nextQuestion() {
      explanationBox.classList.add("hidden");
      setOptionsDisabled(false);

      if (currentIndex + 1 < currentQuestions.length) {
        currentIndex++;
        renderQuestion();
      } else {
        resultScoreEl.textContent = score + " / " + currentQuestions.length;
        showScreen("result");
      }
    }

    function retrySameLevel() {
      if (!lastSetCat || !lastSetLevel) {
        startQuiz(selectedCategory, selectedLevel);
      } else {
        startQuiz(lastSetCat, lastSetLevel);
      }
    }

    // ======================= CSV IMPORT =======================
    function parseCsvQuestions(text, categoryName, levelName) {
      const lines = text.split(/\r?\n/).map((l) => l.trim()).filter((l) => l.length > 0);
      if (lines.length <= 1) {
        alert("CSV minimal berisi header dan satu baris soal.");
        return [];
      }

      const questions = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const sep = line.includes(";") ? ";" : ",";
        const parts = line.split(sep);
        if (parts.length < 7) continue;

        const [qText, aText, bText, cText, dText, correctLetterRaw, explanation] = parts;
        const correctLetter = (correctLetterRaw || "").trim().toLowerCase();
        const validLetters = ["a", "b", "c", "d"];
        const chosenLetter = validLetters.includes(correctLetter) ? correctLetter : "a";

        const id = `${categoryName.slice(0, 3).toLowerCase()}-${levelName
          .slice(0, 2)
          .toLowerCase()}-${i}`;

        questions.push({
          id,
          text: qText.trim(),
          options: [
            { id: "a", text: aText.trim() },
            { id: "b", text: bText.trim() },
            { id: "c", text: cText.trim() },
            { id: "d", text: dText.trim() }
          ],
          answerId: chosenLetter,
          explanation: (explanation || "").trim()
        });
      }
      return questions;
    }

    function importCsvToBank(categoryName, levelName, file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        const qs = parseCsvQuestions(content, categoryName, levelName);
        if (!qs.length) {
          alert("Tidak ada soal valid yang terbaca dari CSV.");
          return;
        }

        if (!QUESTION_BANK[categoryName]) {
          QUESTION_BANK[categoryName] = {};
        }
        QUESTION_BANK[categoryName][levelName] = qs;

        rebuildCategorySelect();
        selectedCategory = categoryName;
        categorySelect.value = selectedCategory;
        selectedLevel = levelName;
        updateLevelSelectForCategory(selectedCategory);
        levelSelect.value = selectedLevel;

        alert("Berhasil impor " + qs.length + " soal ke " + categoryName + " - " + levelName);
      };
      reader.readAsText(file);
    }

    // ======================= EVENT LISTENERS =======================
    categorySelect.addEventListener("change", () => {
      selectedCategory = categorySelect.value;
      updateLevelSelectForCategory(selectedCategory);
    });

    levelSelect.addEventListener("change", () => {
      selectedLevel = levelSelect.value;
    });

    btnStart.addEventListener("click", () => {
      startQuiz(selectedCategory, selectedLevel);
    });

    btnRandom.addEventListener("click", () => {
      categories = Object.keys(QUESTION_BANK);
      const randCat = categories[Math.floor(Math.random() * categories.length)];
      const levels = Object.keys(QUESTION_BANK[randCat]);
      const randLvl = levels[Math.floor(Math.random() * levels.length)];
      selectedCategory = randCat;
      selectedLevel = randLvl;
      categorySelect.value = randCat;
      updateLevelSelectForCategory(randCat);
      levelSelect.value = randLvl;
      startQuiz(randCat, randLvl);
    });

    btnNextQuestion.addEventListener("click", () => {
      nextQuestion();
    });

    btnRetryLevel.addEventListener("click", () => {
      retrySameLevel();
    });

    btnBackHome.addEventListener("click", () => {
      showScreen("home");
    });

    btnResultRetry.addEventListener("click", () => {
      retrySameLevel();
    });

    btnResultHome.addEventListener("click", () => {
      showScreen("home");
    });

    btnToggleAdmin.addEventListener("click", () => {
      adminPanel.classList.toggle("hidden");
    });

    btnImportCsv.addEventListener("click", () => {
      const catName = (adminCategoryInput.value || "").trim();
      const lvlName = (adminLevelInput.value || "").trim();
      const file = csvFileInput.files[0];

      if (!catName || !lvlName) {
        alert("Isi nama mata pelajaran dan level terlebih dahulu.");
        return;
      }
      if (!file) {
        alert("Pilih file CSV terlebih dahulu.");
        return;
      }

      importCsvToBank(catName, lvlName, file);
    });

    // ======================= INIT =======================
    function init() {
      rebuildCategorySelect();
      categorySelect.value = selectedCategory;
      updateLevelSelectForCategory(selectedCategory);
    }

    init();
  </script>
</body>
</html>
